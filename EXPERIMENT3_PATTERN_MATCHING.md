# 实验 3：跨轨迹的模式匹配报告

## 1. 实验目标

从成功轨迹中提取"修复策略子图"，验证其是否能匹配失败轨迹的早期阶段，
从而为 Agent 提供早期干预提示。

## 2. 数据概览

| 指标 | 值 |
|------|-----|
| 成功轨迹数 | 342 |
| 失败轨迹数 | 3224 |
| 提取的策略数 | 278 |
| 匹配的失败轨迹数 | 190 |

## 3. 策略提取结果

### 3.1 按任务类别分布

| 任务类别 | 策略数 |
|---------|--------|
| general | 278 |

### 3.2 典型策略示例

**S000** (general)
- 模式: `search->open->edit->execute->submit...`
- 来源案例: networkx__networkx-3848, sphinx-contrib__matlabdomain-226, Bachmann1234__diff_cover-277


## 4. 模式匹配结果

### 4.1 匹配率

- 尝试匹配: 200 条失败轨迹
- 成功匹配: 190 条 (95.0%)

### 4.2 干预潜力分布

| 潜力等级 | 数量 | 占比 |
|---------|------|------|
| high (高) | 61 | 32.1% |
| medium (中) | 86 | 45.3% |
| low (低) | 43 | 22.6% |

### 4.3 分歧点分析

- **平均分歧点**: 第 8.4 步

| 分歧阶段 | 数量 | 占比 | 干预难度 |
|---------|------|------|---------|
| 早期 (< 5 步) | 43 | 22.6% | 容易 |
| 中期 (5-10 步) | 97 | 51.1% | 中等 |
| 后期 (>= 10 步) | 50 | 26.3% | 困难 |

## 5. 典型匹配案例

### 案例 1: `hgrecco__pint-877`

- **匹配策略**: S025
- **匹配开始**: 第 0 步
- **分歧点**: 第 4 步
- **干预潜力**: high
- **原因**: 早期分歧（第 4 步），干预可阻止后续错误

### 案例 2: `netromdk__vermin-173`

- **匹配策略**: S133
- **匹配开始**: 第 7 步
- **分歧点**: 第 10 步
- **干预潜力**: high
- **原因**: Agent 在第 10 步后进入循环（重复 edit）

### 案例 3: `iterative__dvc-6933`

- **匹配策略**: S109
- **匹配开始**: 第 11 步
- **分歧点**: 第 14 步
- **干预潜力**: high
- **原因**: Agent 在第 14 步后进入循环（重复 create）

### 案例 4: `ResearchObject__ro-crate-py-76`

- **匹配策略**: S002
- **匹配开始**: 第 0 步
- **分歧点**: 第 4 步
- **干预潜力**: high
- **原因**: 早期分歧（第 4 步），干预可阻止后续错误

### 案例 5: `omry__omegaconf-57`

- **匹配策略**: S025
- **匹配开始**: 第 19 步
- **分歧点**: 第 24 步
- **干预潜力**: high
- **原因**: Agent 在第 24 步后进入循环（重复 edit）


## 6. 核心发现

### 6.1 模式匹配的可行性

✅ **95.0%** 的失败轨迹可以匹配到成功策略

✅ **32.1%** 的匹配具有高干预潜力


### 6.2 干预时机的关键性

⚠️ 平均分歧点在第 8.4 步，需要**快速检测机制**

### 6.3 Context Graph 的价值

基于匹配实验，Context Graph 可以：

1. **存储修复策略模板**: 将成功轨迹的关键步骤抽象为可重用模式
2. **提供早期预警**: 在 Agent 开始偏离成功模式时发出警告
3. **推荐下一步动作**: 根据匹配的策略模板，建议最优动作

### 6.4 建议的 Schema 增强

```
StrategyNode:
  - strategy_id: str
  - task_category: str
  - success_rate: float
  - key_steps: List[ActionNode]

MATCHES_STRATEGY 边:
  - 连接当前轨迹到匹配的策略
  - 属性: match_score, diverge_point

SUGGESTS_NEXT 边:
  - 从策略节点到建议的下一步动作
  - 属性: confidence, reason
```

## 7. 结论

本实验验证了 **跨轨迹模式匹配** 的可行性：

1. 可以从成功轨迹中提取有意义的修复策略
2. 这些策略可以匹配到失败轨迹的早期阶段
3. 存在显著的 **干预窗口期**，可以在 Agent 出错前提供帮助

这为 Context Graph 的核心价值提供了实验依据：
> **通过存储和匹配历史成功经验，可以为 Agent 提供实时的策略建议，
> 避免重复已知的失败模式。**

---

**分析完成时间**: 2026-02-06
**数据来源**: 3566 条 SWE-agent 轨迹
**方法**: 策略提取 + 序列匹配 + 干预潜力分析
