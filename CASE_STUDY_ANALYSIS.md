# SWE-agent 失败案例深度分析

## 概述

本报告基于从 3,591 个轨迹中挑选的典型案例进行深度分析，揭示 SWE-agent 失败的根本原因。

---

## 典型案例分析

### 案例 1: `iterative__dvc-6933` (226 步，失败)
**失败类型：循环陷阱 + 任务理解错误**

#### 任务描述
为 DVC 添加 parallel coordinates plot 功能（功能请求，非 bug 修复）

#### 决策链分析

```
步骤 1-3: 创建复现脚本
  ↓ ❌ 错误：这是功能请求，不是 bug
步骤 4-6: 遇到 pygit2 依赖错误
  ↓ ❌ 错误：尝试通过 pip install 解决环境问题
步骤 7-10: 安装旧版本 pygit2
  ↓ 依然失败
步骤 11-50: 反复运行 dvc exp show
  ↓ ❌ 陷入超时循环
步骤 51-226: 创建输出文件、重定向输出...
  ↓ ❌ 完全偏离正轨
```

#### 关键错误点

| 步骤 | 错误类型 | 描述 |
|------|---------|------|
| 1 | 任务理解 | 把功能请求当作 bug 修复处理 |
| 6 | 策略选择 | 尝试用环境修复代替代码实现 |
| 11+ | 循环陷阱 | 重复执行超时命令 50+ 次 |
| 51+ | 方向迷失 | 创建无意义的输出文件 |

#### 核心洞察
> **Agent 从未尝试阅读现有代码或理解如何实现该功能。** 它完全陷入了"复现 bug"的固定模式，忽略了这是一个需要编写新代码的功能请求。

---

### 案例 2: `aio-libs__aioftp-113` (6 步，失败)
**失败类型：技术知识错误 + 缺乏验证**

#### 任务描述
修复 `parse_ls_date` 函数不能处理单空格日期格式的问题

#### 决策链分析

```
步骤 1: search_dir "def parse_ls_date" → 找到 client.py
  ↓ ✅ 正确
步骤 2: open aioftp/client.py → 打开文件
  ↓ ✅ 正确
步骤 3: search_file → 定位到第 360 行
  ↓ ✅ 正确
步骤 4: goto 360 → 查看代码
  ↓ ✅ 正确
步骤 5: edit 387:387 → 将 "%b %d %H:%M" 改为 "%b %d%s%H:%M"
  ↓ ❌ 错误：%s 在 strptime 中无效
步骤 6: submit → 直接提交
  ↓ ❌ 测试失败
```

#### 关键错误分析

**原始代码**:
```python
d = datetime.datetime.strptime(s, "%b %d %H:%M")
```

**Agent 修改**:
```python
d = datetime.datetime.strptime(s, "%b %d%s%H:%M")  # ❌ %s 无效
```

**正确修改应该是**:
```python
# 方案 1: 使用 strip() 预处理
s = s.strip()
d = datetime.datetime.strptime(s, "%b %d %H:%M")

# 方案 2: 正则表达式处理可变空格
import re
s = re.sub(r'\s+', ' ', s)
```

#### 核心洞察
> **Agent 正确定位了问题，但对 Python strptime 格式字符串的理解有误。** 更重要的是，它没有运行测试来验证修改的正确性就直接提交了。

---

### 案例 3: `networkx__networkx-3848` (8 步，成功)
**成功案例：对照组**

#### 任务描述
修复 `minimum_st_node_cut` 返回空列表而非空集合的问题

#### 决策链分析

```
步骤 1: find_file "cuts.py" → 找到文件
  ↓ ✅
步骤 2: open cuts.py 284 → 直接跳到问题行
  ↓ ✅
步骤 3: edit 284:284 → return [] 改为 return {}
  ↓ ✅
步骤 4-6: 查找测试目录
  ↓ ✅
步骤 7: 尝试运行测试（失败，缺少 numpy）
  ↓ 环境限制
步骤 8: submit
  ↓ ✅ 测试通过
```

#### 成功因素

| 因素 | 描述 |
|------|------|
| 问题清晰 | issue 直接给出了文件路径和行号 |
| 修改简单 | 只需将 `[]` 改为 `{}` |
| 路径直接 | 没有探索、没有迷失 |

---

### 案例 4: `projectmesa__mesa-1343` (30 步，失败)
**失败类型：不完整重构 + 编辑命令误用**

#### 任务描述
将 `UserSettableParameter` 类拆分为 `Number`, `Checkbox`, `Slider` 等独立类

#### 决策链分析

```
步骤 1-2: 搜索并找到 UserParam.py
  ↓ ✅
步骤 3-4: 打开文件，理解现有结构
  ↓ ✅
步骤 5: 大规模编辑（替换 92 行代码）
  ↓ ⚠️ 问题开始：新类缺少 @property 方法
步骤 6: 尝试删除剩余代码
  ↓ ❌ 错误行号导致语法错误
步骤 7-30: 反复尝试 "edit 53:100" 或 "edit 8:100"
  ↓ ❌ 陷入循环：相同命令重复 10+ 次
```

#### 编辑错误详解

**第一次编辑后的文件状态**（部分）:
```python
class Number:
    def __init__(self, name="", value=None, ...):
        self._value = value
        # 验证逻辑
        valid = not (self.value is None)  # ❌ self.value 调用了不存在的 property

class Checkbox:
    # 同样缺少 @property value
```

**Agent 遗漏的关键代码**:
```python
@property
def value(self):
    return self._value

@value.setter
def value(self, value):
    self._value = value
    # ... 验证逻辑

@property
def json(self):
    # ... 序列化逻辑
```

#### 核心洞察
> **Agent 在重构时只复制了部分代码，遗漏了关键的 property 方法。** 当遇到语法错误时，它不断重复相同的失败命令，没有尝试不同的策略。

---

## 失败模式总结

### 模式 1: 循环陷阱 (出现于案例 1, 4)

```
┌─────────────────────────────────────────────┐
│          触发条件                            │
│  - 命令超时或失败                            │
│  - 期望结果未出现                            │
└──────────────────┬──────────────────────────┘
                   ↓
┌─────────────────────────────────────────────┐
│          错误响应                            │
│  - 重复执行相同命令                          │
│  - 期望不同结果                              │
└──────────────────┬──────────────────────────┘
                   ↓
┌─────────────────────────────────────────────┐
│          恶化循环                            │
│  - 消耗大量步骤                              │
│  - 偏离任务目标                              │
└─────────────────────────────────────────────┘
```

**建议**: 检测连续 3 次相同操作，强制切换策略

### 模式 2: 任务理解错误 (出现于案例 1)

| 任务类型 | Bug 修复 | 功能请求 |
|---------|---------|---------|
| 首要动作 | 复现问题 | 理解需求 |
| 主要工作 | 定位并修改 | 设计并实现 |
| 验证方式 | 复现脚本 | 功能测试 |

**建议**: 在开始前明确任务类型，采用相应策略

### 模式 3: 技术知识缺陷 (出现于案例 2)

```
Agent 的假设: "%s" 可以匹配可变空格
实际情况: strptime 中 %s 无效

→ 修改引入新 bug
→ 没有测试验证
→ 直接提交失败
```

**建议**: 对于不确定的 API 用法，先写测试验证

### 模式 4: 不完整重构 (出现于案例 4)

```
原始类: UserSettableParameter
         ├── __init__()
         ├── @property value
         ├── @value.setter
         └── @property json

重构后: Number, Checkbox, Slider...
         └── __init__()  ← 只复制了这部分
```

**建议**: 重构前列出完整的方法清单，确保无遗漏

---

## 改进建议

### 1. 循环检测机制
```python
if consecutive_same_action >= 3:
    force_strategy_change()
```

### 2. 任务分类器
```python
task_type = classify_task(issue_text)
if task_type == "feature_request":
    strategy = design_and_implement()
elif task_type == "bug_fix":
    strategy = reproduce_and_fix()
```

### 3. 修改验证流程
```
编辑 → 语法检查 → 单元测试 → 提交
       ↓ 失败      ↓ 失败
       回滚        回滚
```

### 4. 重构检查清单
```
□ 列出所有需要迁移的方法
□ 检查属性访问器
□ 验证导入语句
□ 更新其他引用
```

---

## 数据支持

| 指标 | 值 | 来源 |
|-----|-----|-----|
| 总轨迹数 | 3,591 | 完整数据集 |
| 失败率 | 90.48% | 统计分析 |
| 平均失败步骤 | 30.4 | 统计分析 |
| 早期失败占比 | 73.6% | 前 10 步失败 |
| 循环陷阱率 | 80% | 失败案例 |

---

**分析完成时间**: 2026-02-06
**分析方法**: 典型案例深度剖析
**案例来源**: SWE-bench Lite + SWE-agent (Llama-70B)
